# 修复步骤

**重要提示：这是自动化流程中的第4步（共4步）：规划 → 执行 → 审查 → 修复。**
- **无需人工干预** - 自动修复审查中发现的问题
- **不要提问或请求批准** - 直接修复问题
- **保持直接和客观** - 无需对话性语言

读取.task文件中的REVIEW_RESULT。按优先级修复问题。

## 无需修复？在此停止。
如果审查显示：
- OUTCOME_ACHIEVED: yes（是）
- 无ENVIRONMENT_ISSUES（空或"none"）
- 无BLOCKERS（空或"none"）
- 无ISSUES（空或"none"）

那么**你无需做任何事**。只需：
1. 删除.task文件
2. 确保在TASKS.md中任务标记为`- [x]`
3. **立即停止** - **不要**实现新代码，**不要**开始新任务

修复步骤**仅修复**审查发现的问题。它**不**：
- 实现新功能
- 开始下一个任务
- 添加审查未标记的改进
- 做任何超出修复标记问题范围的事情

如果没有问题，你的全部工作就是：删除.task文件，标记为完成，结束。

## 优先级顺序（仅当存在问题）
1. ❌ OUTCOME_ACHIEVED: no（否）- 任务未完成！首先修复实现。
2. 🔧 ENVIRONMENT_ISSUES（环境问题）- **创建修复任务**
3. 🔴 BLOCKERS（阻塞问题）- 必须修复的代码问题
4. 🟡 ISSUES（问题）- 如果直接则修复
5. 🟢 SUGGESTIONS（建议）- 仅在简单时修复

## 如果OUTCOME_ACHIEVED为"no"（否）
实现没有达到任务要求。你必须：
1. 从.task文件读取EXPECTED_OUTCOME和OUTCOME_EVIDENCE
2. 找出**为什么**结果未达成
3. 修复实现**直到**结果达成
4. 在继续之前**重新验证**结果
这**不是可选的** - 没有达成结果的任务不算完成。

## 处理ENVIRONMENT_ISSUES（环境问题，关键！）
环境问题是**可解决的**。你必须：
1. 从.task文件读取REMEDIATION
2. **向TASKS.md添加新任务**来修复环境问题
   - 将其插入当前任务**之前**（以便下次迭代运行）
   - 格式：`- [ ] Setup: [修复操作]`
   - 示例：
     - `- [ ] Setup: 在Dockerfile.dev中安装Chromium和依赖项`
     - `- [ ] Setup: 将缺失的npm包X添加到依赖项`
     - `- [ ] Setup: 配置Docker以支持工具Y`
3. 将当前任务标记**改回**`- [ ]`（环境修复后将重试）
4. 删除.task文件
5. **不要**标记为已阻塞 - 环境任务会修复它

## 你的代码问题处理工作
1. 修复BLOCKERS（必需）
2. 修复ISSUES（应该修复）
3. 考虑SUGGESTIONS（有则更好）
4. 重新运行TEST_COMMAND确认
5. 提交修复："fix: [描述]"

**重要提示：修复所有标记的问题，不仅仅是当前任务的问题。**
如果审查标记了预先存在的问题（构建失败、db:push失败等），
你**必须**修复它。不要因为"另一个任务导致"而跳过问题。
损坏的代码库会阻塞所有未来工作 - 立即修复它。

## 绝不在测试上作弊
测试失败时，你必须修复**实现**，而不是测试。

**禁止的"修复"（实际上是作弊）：**
- Mock返回值以使测试通过
- 弱化断言（将`toBe(5)`改为`toBeTruthy()`）
- 删除失败的测试用例
- 添加`.skip`或注释掉失败的测试
- 将被测试函数stub以返回期望值

**可以修改测试的唯一情况：**
- 测试本身有错误（期望值错误、拼写错误）
- 上游更改使测试假设无效（API更改、模式更改）
- **且**你验证修改后测试仍然测试有意义的行为

如果测试失败，测试正在履行职责 - 它发现了错误。修复错误。
一个因为你破坏而总是通过的测试套件毫无价值。

## 修复后
如果全部修复 + 测试通过：
- 删除.task文件
- 确保在TASKS.md中任务标记为`- [x]`（如有用可加备注）

如果发现环境问题：
- 向TASKS.md添加修复任务（见上文）
- 取消当前任务标记
- 删除.task文件
- **继续**（不被阻塞！）

如果遇到**真正的代码阻塞问题**（罕见 - 仅限安全/数据问题且无修复方案）：
- 在TASKS.md中将任务标记改回`- [ ]`
- 添加阻塞备注：`- [ ] 任务描述 ⚠️ 阻塞: [原因]`
- 保留.task文件供上下文参考