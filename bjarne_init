#!/bin/bash

# -e: å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º
# -u: ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™
set -eu

# æ•è· ERR ä¿¡å·ï¼Œæ˜¾ç¤ºé”™è¯¯ä½ç½®
trap 'echo "é”™è¯¯å‘ç”Ÿåœ¨: $BASH_SOURCE ç¬¬ $LINENO è¡Œ, å‘½ä»¤: $BASH_COMMAND"' ERR

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

# bjarneæ‰§è¡Œåœºæ™¯
export BJARNE_EXECUTE_SCENE="init"

# Instance-specific temp folder for verbose command output
# Uses PID + timestamp for uniqueness across concurrent instances
BJARNE_INSTANCE_ID="$$_$(date +%s)"
BJARNE_TMP_DIR="/tmp/bjarne-${BJARNE_EXECUTE_SCENE}-${BJARNE_INSTANCE_ID}"
export BJARNE_TMP_DIR

# sessionç›¸å…³å˜é‡
BJARNE_CLAUDE_SESSION_IS_NEW="true"
BJARNE_CLAUDE_SESSION_ID=$(uuidgen)

# Source library components
source "$SCRIPT_DIR/lib/consts.sh"
source "$SCRIPT_DIR/lib/tools.sh"
source "$SCRIPT_DIR/lib/log.sh"
source "$SCRIPT_DIR/lib/prompts.sh"
source "$SCRIPT_DIR/lib/safe_mode.sh"
source "$SCRIPT_DIR/lib/claude.sh"

log "LIGHT" "ğŸš€ Starting Bjarne initialization script..."
log "INFO" "BJARNE_EXECUTE_SCENE=$BJARNE_EXECUTE_SCENE"
log "INFO" "SCRIPT_DIR=$SCRIPT_DIR"
log "INFO" "BJARNE_HOME=$BJARNE_HOME"
log "INFO" "BJARNE_PROJECT_ROOT=$BJARNE_PROJECT_ROOT"
log "INFO" "LOG_DIR=$LOG_DIR"
log "INFO" "LOG_FILE=$LOG_FILE"
log "INFO" "BJARNE_TMP_DIR=$BJARNE_TMP_DIR"
log "INFO" "BJARNE_CLAUDE_SESSION_IS_NEW=$BJARNE_CLAUDE_SESSION_IS_NEW"
log "INFO" "BJARNE_CLAUDE_SESSION_ID=$BJARNE_CLAUDE_SESSION_ID"
log "INFO" ""

#==============================================================================
# BJARNE INIT

#==============================================================================
# INIT COMMAND - Bootstrap from idea file (works on new or existing projects)
#==============================================================================

# Parse --safe flag and idea file
INIT_SAFE_MODE=false
IDEA_FILE=""

# Helper å‡½æ•°ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
ç”¨æ³•: $0 [é€‰é¡¹]

é€‰é¡¹:
  --safe          å¯ç”¨å®‰å…¨æ¨¡å¼
  -f, --file FILE æŒ‡å®š IDEA æ–‡ä»¶è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
  -h, --help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  $0 --safe --file /path/to/project.idea
  $0 -f ./myproject.idea
EOF
}

# Helper å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯å¹¶é€€å‡º
show_error() {
    echo "é”™è¯¯: $1" >&2
    echo "ä½¿ç”¨ $0 --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯" >&2
    exit 1
}

# Helper å‡½æ•°ï¼šæ˜¾ç¤ºæœªçŸ¥é€‰é¡¹é”™è¯¯
handle_unknown_option() {
    show_error "æœªçŸ¥é€‰é¡¹ '$1'"
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        --safe)
            INIT_SAFE_MODE=true
            shift
            ;;
        -f|--file)
            if [[ -z "${2:-}" ]]; then
                echo "é”™è¯¯ï¼š$1 é€‰é¡¹éœ€è¦ä¼ æ–‡ä»¶è·¯å¾„" >&2
                exit 1
            fi
            IDEA_FILE="$2"  # æ­£ç¡®çš„ï¼šå–ä¸‹ä¸€ä¸ªå‚æ•°ä½œä¸ºæ–‡ä»¶è·¯å¾„
            shift 2  # è·³è¿‡ä¸¤ä¸ªå‚æ•°ï¼ˆé€‰é¡¹å’Œå€¼ï¼‰
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            handle_unknown_option "$1"
            ;;
    esac
done

if [[ -z "$IDEA_FILE" ]]; then
    log "ERROR" "Usage: bjarne-init -f <idea.md> [--safe]"
    exit 1
fi

if [[ ! -f "$IDEA_FILE" ]]; then
    log "ERROR" "$IDEA_FILE not found"
    exit 1
fi

# Detect if this is an existing project (has source code files)
EXISTING_PROJECT="false"
SRC_FILES=$(find . -maxdepth 3 -type f \( -name "*.sql" -o -name "*.html" -o -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.php" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.tsx" -o -name "*.jsx" \) 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v __pycache__ | head -20)
# [[ -n "$SRC_FILES" ]] && EXISTING_PROJECT="true"
# Prompt user to confirm
if [[ -n "$SRC_FILES" ]]; then
    log "INFO" "Detected source code files."

    while true; do
        read -n1 -p "è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„é¡¹ç›®ï¼Ÿ(y/n): " yn
        echo ""  # æ‰‹åŠ¨æ¢è¡Œï¼Œä½¿ç•Œé¢æ•´æ´
        case $yn in
            [Yy])
                EXISTING_PROJECT="true"
                break
                ;;
            [Nn])
                EXISTING_PROJECT="false"
                break
                ;;
            *)
                echo "è¯·è¾“å…¥ yï¼ˆæ˜¯ï¼‰æˆ– nï¼ˆå¦ï¼‰ã€‚"
                ;;
        esac
    done
else
    log "INFO" "æœªæ£€æµ‹åˆ°å¸¸è§æºä»£ç æ–‡ä»¶ï¼Œå‡è®¾ä¸ºæ–°é¡¹ç›®ã€‚"
fi

if [[ "$EXISTING_PROJECT" == "true" ]]; then
    log "LIGHT" "Bjarne initializing EXISTING project from: $IDEA_FILE"
else
    log "LIGHT" "Bjarne initializing NEW project from: $IDEA_FILE"
fi

# Detect existing environment
DETECTED=""
[[ -f "package.json" ]] && DETECTED="${DETECTED}Found: package.json (Node.js/JavaScript)\n"
[[ -f "tsconfig.json" ]] && DETECTED="${DETECTED}Found: tsconfig.json (TypeScript)\n"
[[ -f "composer.json" ]] && DETECTED="${DETECTED}Found: composer.json (PHP)\n"
[[ -f "requirements.txt" ]] && DETECTED="${DETECTED}Found: requirements.txt (Python)\n"
[[ -f "pyproject.toml" ]] && DETECTED="${DETECTED}Found: pyproject.toml (Python)\n"
[[ -f "pubspec.yaml" ]] && DETECTED="${DETECTED}Found: pubspec.yaml (Flutter/Dart)\n"
[[ -f "Cargo.toml" ]] && DETECTED="${DETECTED}Found: Cargo.toml (Rust)\n"
[[ -f "go.mod" ]] && DETECTED="${DETECTED}Found: go.mod (Go)\n"
[[ -f "CLAUDE.md" ]] && DETECTED="${DETECTED}Found: CLAUDE.md (existing project rules)\n"
[[ -f ".env.example" ]] && DETECTED="${DETECTED}Found: .env.example (needs .env setup)\n"
[[ -d "node_modules" ]] || [[ -f "package.json" ]] && [[ ! -d "node_modules" ]] && DETECTED="${DETECTED}Note: node_modules missing - needs npm install\n"
[[ -d "vendor" ]] || [[ -f "composer.json" ]] && [[ ! -d "vendor" ]] && DETECTED="${DETECTED}Note: vendor missing - needs composer install\n"
[[ -f "pom.xml" ]] && DETECTED="${DETECTED}Found: pom.xml (Java/Maven)\n"

# For existing projects, include source file list
EXISTING_CODE_INFO=""
if [[ "$EXISTING_PROJECT" == "true" ]]; then
    EXISTING_CODE_INFO="
## EXISTING SOURCE FILES (explore these to understand what's built):
$SRC_FILES

This is an EXISTING project. You MUST:
1. Explore and understand the existing codebase structure
2. Read key files to understand what's already implemented
3. Document existing functionality in CONTEXT.md
4. Create tasks that BUILD ON existing code, not duplicate it
"
fi

INIT_PROMPT=$(get_init_prompt)

IDEA_CONTENT=$(cat "$IDEA_FILE")

# Read CLAUDE.md if exists
CLAUDE_MD=""
if [[ -f "CLAUDE.md" ]]; then
    CLAUDE_MD="

## Existing CLAUDE.md (project rules to respect):
$(cat CLAUDE.md)
"
fi

user_prompt="# IDEA CONTENT:

$IDEA_CONTENT

---

## DETECTED ENVIRONMENT:
$DETECTED
$EXISTING_CODE_INFO
$CLAUDE_MD
---

$INIT_PROMPT"

run_claude "user_prompt" "$user_prompt" \
    "phase" "INIT" \
    "session_is_new" "$BJARNE_CLAUDE_SESSION_IS_NEW" \
    "session_id" "$BJARNE_CLAUDE_SESSION_ID" \
    "save_mode" "false"

# Verify files were created
if [[ -f "$CONTEXT_FILE" ]] && [[ -f "$TASK_FILE" ]]; then
    log "SUCCESS" "Project initialized!"
    log "INFO" "  - $CONTEXT_FILE"
    log "INFO" "  - $TASK_FILE"
    [[ -d "$SPECS_DIR" ]] && log "INFO" "  - $SPECS_DIR/"

    # Init git repo if git available and not already in a repo
    if command -v git &> /dev/null; then
        if ! git rev-parse --git-dir &> /dev/null 2>&1; then
            git init -q && \
            git add -A && \
            git commit -q -m "Initial project setup by Bjarne" && \
            log "INFO" "  - git repo initialized" || true
        fi
    fi

    # Generate Docker config if --safe flag was used
    if [[ "$INIT_SAFE_MODE" == true ]]; then
        log "INFO" "Generating Docker configuration for safe mode..."
        generate_dockerfile

        # Add .bjarne to .gitignore if not already there
        if [[ -f ".gitignore" ]]; then
            if ! grep -q "^\.bjarne/" ".gitignore" 2>/dev/null; then
                log "INFO" ".bjarne/" >> ".gitignore"
            fi
        else
            echo ".bjarne/" > ".gitignore"
        fi
        log "INFO" "  - Added .bjarne/ to .gitignore"

        log "INFO" ""
        log "SUCCESS" "Safe mode enabled!"
        log "INFO" "Container will only have access to this project directory."
    fi

    log "INFO" ""
    log "INFO" "Run 'bjarne' to start development"
else
    log "ERROR" "Initialization incomplete - check output above"
fi

exit 0