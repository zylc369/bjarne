#!/bin/bash

set -e

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

# Source library components
source "$SCRIPT_DIR/lib/consts.sh"
source "$SCRIPT_DIR/lib/log.sh"
source "$SCRIPT_DIR/lib/prompts.sh"
source "$SCRIPT_DIR/lib/safe_mode.sh"
source "$SCRIPT_DIR/lib/claude.sh"

echo "SCRIPT_DIR=$SCRIPT_DIR"
echo "BJARNE_HOME=$BJARNE_HOME"
echo "BJARNE_PROJECT_ROOT=$BJARNE_PROJECT_ROOT"
echo "LOG_DIR=$LOG_DIR"
echo "LOG_FILE=$LOG_FILE"

#==============================================================================
# BJARNE INIT

#==============================================================================
# INIT COMMAND - Bootstrap from idea file (works on new or existing projects)
#==============================================================================
if [[ "$1" == "init" ]]; then
    # Parse --safe flag and idea file
    INIT_SAFE_MODE=false
    IDEA_FILE=""

    shift  # Remove "init" from args
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --safe)
                INIT_SAFE_MODE=true
                shift
                ;;
            *)
                IDEA_FILE="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$IDEA_FILE" ]]; then
        echo -e "${RED}Usage: bjarne init [--safe] <idea.md>${NC}"
        exit 1
    fi

    if [[ ! -f "$IDEA_FILE" ]]; then
        echo -e "${RED}Error: $IDEA_FILE not found${NC}"
        exit 1
    fi

    # Detect if this is an existing project (has source code files)
    EXISTING_PROJECT="false"
    SRC_FILES=$(find . -maxdepth 3 -type f \( -name "*.sql" -o -name "*.html" -o -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.php" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.tsx" -o -name "*.jsx" \) 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v __pycache__ | head -20)
    # [[ -n "$SRC_FILES" ]] && EXISTING_PROJECT="true"
    # Prompt user to confirm
    if [[ -n "$SRC_FILES" ]]; then
        echo "检测到源代码文件。"

        while true; do
            read -n1 -p "这是否是一个已存在的项目？(y/n): " yn
            echo ""  # 手动换行，使界面整洁
            case $yn in
                [Yy])
                    EXISTING_PROJECT="true"
                    break
                    ;;
                [Nn])
                    EXISTING_PROJECT="false"
                    break
                    ;;
                *)
                    echo "请输入 y（是）或 n（否）。"
                    ;;
            esac
        done
    else
        echo "未检测到常见源代码文件，假设为新项目。"
    fi

    if [[ "$EXISTING_PROJECT" == "true" ]]; then
        echo -e "${CYAN}Bjarne initializing EXISTING project from: $IDEA_FILE${NC}"
    else
        echo -e "${CYAN}Bjarne initializing NEW project from: $IDEA_FILE${NC}"
    fi

    # Detect existing environment
    DETECTED=""
    [[ -f "package.json" ]] && DETECTED="${DETECTED}Found: package.json (Node.js/JavaScript)\n"
    [[ -f "tsconfig.json" ]] && DETECTED="${DETECTED}Found: tsconfig.json (TypeScript)\n"
    [[ -f "composer.json" ]] && DETECTED="${DETECTED}Found: composer.json (PHP)\n"
    [[ -f "requirements.txt" ]] && DETECTED="${DETECTED}Found: requirements.txt (Python)\n"
    [[ -f "pyproject.toml" ]] && DETECTED="${DETECTED}Found: pyproject.toml (Python)\n"
    [[ -f "pubspec.yaml" ]] && DETECTED="${DETECTED}Found: pubspec.yaml (Flutter/Dart)\n"
    [[ -f "Cargo.toml" ]] && DETECTED="${DETECTED}Found: Cargo.toml (Rust)\n"
    [[ -f "go.mod" ]] && DETECTED="${DETECTED}Found: go.mod (Go)\n"
    [[ -f "CLAUDE.md" ]] && DETECTED="${DETECTED}Found: CLAUDE.md (existing project rules)\n"
    [[ -f ".env.example" ]] && DETECTED="${DETECTED}Found: .env.example (needs .env setup)\n"
    [[ -d "node_modules" ]] || [[ -f "package.json" ]] && [[ ! -d "node_modules" ]] && DETECTED="${DETECTED}Note: node_modules missing - needs npm install\n"
    [[ -d "vendor" ]] || [[ -f "composer.json" ]] && [[ ! -d "vendor" ]] && DETECTED="${DETECTED}Note: vendor missing - needs composer install\n"
    [[ -f "pom.xml" ]] && DETECTED="${DETECTED}Found: pom.xml (Java/Maven)\n"

    # For existing projects, include source file list
    EXISTING_CODE_INFO=""
    if [[ "$EXISTING_PROJECT" == "true" ]]; then
        EXISTING_CODE_INFO="
## EXISTING SOURCE FILES (explore these to understand what's built):
$SRC_FILES

This is an EXISTING project. You MUST:
1. Explore and understand the existing codebase structure
2. Read key files to understand what's already implemented
3. Document existing functionality in CONTEXT.md
4. Create tasks that BUILD ON existing code, not duplicate it
"
    fi

    INIT_PROMPT=$(cat "${SCRIPT_DIR}/resources/prompt_init.md")

    IDEA_CONTENT=$(cat "$IDEA_FILE")

    # Read CLAUDE.md if exists
    CLAUDE_MD=""
    if [[ -f "CLAUDE.md" ]]; then
        CLAUDE_MD="

## Existing CLAUDE.md (project rules to respect):
$(cat CLAUDE.md)
"
    fi

    run_claude "# IDEA FILE CONTENT:

$IDEA_CONTENT

---

## DETECTED ENVIRONMENT:
$DETECTED
$EXISTING_CODE_INFO
$CLAUDE_MD
---

$INIT_PROMPT" "INIT" "false"

    # Verify files were created
    if [[ -f "$CONTEXT_FILE" ]] && [[ -f "$TASK_FILE" ]]; then
        echo -e "${GREEN}Project initialized!${NC}"
        echo -e "  - $CONTEXT_FILE"
        echo -e "  - $TASK_FILE"
        [[ -d "$SPECS_DIR" ]] && echo -e "  - $SPECS_DIR/"

        # Init git repo if git available and not already in a repo
        if command -v git &> /dev/null; then
            if ! git rev-parse --git-dir &> /dev/null 2>&1; then
                git init -q && \
                git add -A && \
                git commit -q -m "Initial project setup by Bjarne" && \
                echo -e "  - git repo initialized" || true
            fi
        fi

        # Generate Docker config if --safe flag was used
        if [[ "$INIT_SAFE_MODE" == true ]]; then
            echo -e "${CYAN}Generating Docker configuration for safe mode...${NC}"
            generate_dockerfile

            # Add .bjarne to .gitignore if not already there
            if [[ -f ".gitignore" ]]; then
                if ! grep -q "^\.bjarne/" ".gitignore" 2>/dev/null; then
                    echo ".bjarne/" >> ".gitignore"
                fi
            else
                echo ".bjarne/" > ".gitignore"
            fi
            echo -e "  - Added .bjarne/ to .gitignore"

            echo ""
            echo -e "${GREEN}Safe mode enabled!${NC}"
            echo -e "Container will only have access to this project directory."
        fi

        echo ""
        echo -e "${CYAN}Run 'bjarne' to start development${NC}"
    else
        echo -e "${RED}Initialization incomplete - check output above${NC}"
    fi

    exit 0
fi